<div class="container mt-4">
  <h2 class="mb-3">
    <i class="bi bi-calendar-check"></i> Mis Reservas
  </h2>

  <!-- Loading spinner -->
  <div *ngIf="cargando" class="text-center my-5">
    <div class="spinner-border text-success" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Cargando reservas...</p>
  </div>

  <div *ngIf="!cargando">
    <!-- Filtros -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <i class="bi bi-funnel"></i> Filtros de B칰squeda
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Fecha Desde -->
          <div class="col-md-3">
            <label class="form-label"><i class="bi bi-calendar3"></i> Fecha Desde:</label>
            <input type="date" class="form-control" [(ngModel)]="filtroFechaDesde" (change)="filtrarReservas()">
          </div>
          <!-- Fecha Hasta -->
          <div class="col-md-3">
            <label class="form-label"><i class="bi bi-calendar3"></i> Fecha Hasta:</label>
            <input type="date" class="form-control" [(ngModel)]="filtroFechaHasta" (change)="filtrarReservas()">
          </div>

          <!-- Tipo (Aula/Material) -->
          <div class="col-md-3">
            <label class="form-label"><i class="bi bi-tag"></i> Tipo:</label>
            <select class="form-select" [(ngModel)]="filtroTipo" (change)="filtrarReservas()">
              <option value="Todas">Todas</option>
              <option value="Aula">Aula</option>
              <option value="Material">Material</option>
            </select>
          </div>

          <!-- Aula (solo si tipo es Aula) -->
          <div class="col-md-3" *ngIf="filtroTipo === 'Aula' || filtroTipo === 'Todas'">
            <label class="form-label"><i class="bi bi-door-open"></i> Aula:</label>
            <select class="form-select" [(ngModel)]="filtroAula" (change)="filtrarReservas()">
              <option value="">Todas las aulas</option>
              <option *ngFor="let espacio of espacios" [value]="espacio.nombre">
                {{ espacio.nombre }}
              </option>
            </select>
          </div>

          <!-- Material (solo si tipo es Material) -->
          <div class="col-md-3" *ngIf="filtroTipo === 'Material' || filtroTipo === 'Todas'">
            <label class="form-label"><i class="bi bi-box"></i> Material:</label>
            <select class="form-select" [(ngModel)]="filtroMaterial" (change)="filtrarReservas()">
              <option value="">Todos los materiales</option>
              <option *ngFor="let material of materiales" [value]="material.nombre">
                {{ material.nombre }}
              </option>
            </select>
          </div>

          <!-- Botones -->
          <div class="col-md-12 d-flex gap-2">
            <button class="btn btn-secondary" (click)="limpiarFiltros()">
              <i class="bi bi-x-circle"></i> Limpiar Filtros
            </button>
            <button class="btn btn-success" (click)="exportarPDFTodasReservas()"
              [disabled]="filtradoReservas.length === 0">
              <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
      <span>
        <i class="bi bi-info-circle"></i>
        Mostrando <strong>{{ filtradoReservas.length }}</strong> reservas
        <span *ngIf="filtroFechaDesde && filtroFechaHasta">
          del <strong>{{ filtroFechaDesde }}</strong> al <strong>{{ filtroFechaHasta }}</strong>
        </span>
      </span>
      <span class="badge bg-primary">
        Total: {{ reservas.length }}
      </span>
    </div>

    <!-- Lista de reservas -->
    <div *ngIf="reservasPaginadas.length > 0; else noResultados">
      <div class="card mb-3" *ngFor="let r of reservasPaginadas" [ngClass]="{
             'border-warning': r.estado === 'Pendiente' && esMiReserva(r),
             'border-info': r.estado === 'En curso' && esMiReserva(r),
             'border-success': r.estado === 'Finalizada' && esMiReserva(r),
             'border-secondary': !esMiReserva(r)
           }">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="card-title mb-2">
                <i class="bi" [ngClass]="r.tipo === 'Aula' ? 'bi-door-open' : 'bi-box'"></i>
                {{ r.tipo === 'Aula' ? r.espacio : r.recurso }}
                <span class="badge ms-2" [ngClass]="{
                        'bg-warning': r.estado === 'Pendiente',
                        'bg-info': r.estado === 'En curso',
                        'bg-success': r.estado === 'Finalizada'
                      }">
                  {{ r.estado }}
                </span>
                <!-- Badge si NO es tu reserva -->
                <span class="badge bg-secondary ms-2" *ngIf="!esMiReserva(r)">
                  <i class="bi bi-eye"></i> Solo visualizaci칩n
                </span>
              </h5>
              <p class="card-text mb-0">
                <i class="bi bi-calendar3"></i> <strong>Fecha:</strong> {{ r.fecha }}<br>
                <i class="bi bi-clock"></i> <strong>Horario:</strong> {{ r.tramoHorario }}<br>
                <i class="bi bi-person-badge"></i> <strong>Profesor:</strong> {{ r.profesor }}<br>
                <i class="bi bi-tag"></i> <strong>Tipo:</strong> {{ r.tipo }}
              </p>
            </div>
            <div class="col-md-4 text-end">
              <!-- 游댠 Solo mostrar botones si es MI reserva -->
              <div class="d-flex justify-content-end gap-2">
                <ng-container *ngIf="esMiReserva(r); else soloVisualizacion">
                  <button class="btn btn-outline-primary btn-sm" (click)="modificarReserva(r)"
                    [disabled]="procesando || !puedeModificar(r)">
                    <i class="bi bi-pencil"></i> Editar
                  </button>
                  <button class="btn btn-outline-danger btn-sm" (click)="eliminarReserva(r)"
                    [disabled]="procesando || !puedeEliminar(r)">
                    <i class="bi bi-trash"></i> Cancelar
                  </button>
                </ng-container>
                <ng-template #soloVisualizacion>
                  <!-- Sin botones para reservas ajenas -->
                </ng-template>
              </div>
              <!-- Si NO es mi reserva, no mostrar botones -->
            </div>
          </div>
        </div>
      </div>

      <!-- Paginaci칩n -->
      <nav class="d-flex justify-content-center mt-4" *ngIf="totalPages > 1">
        <ul class="pagination">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="cambiarPagina(currentPage - 1)" style="cursor: pointer;">
              <i class="bi bi-chevron-left"></i> Anterior
            </a>
          </li>
          <li class="page-item disabled">
            <span class="page-link">P치gina {{ currentPage }} de {{ totalPages }}</span>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="cambiarPagina(currentPage + 1)" style="cursor: pointer;">
              Siguiente <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <ng-template #noResultados>
      <div class="alert alert-warning text-center mt-4">
        <i class="bi bi-exclamation-triangle fs-1"></i>
        <p class="mb-0 mt-2">No hay reservas que coincidan con los filtros aplicados.</p>
        <button class="btn btn-sm btn-outline-warning mt-2" (click)="limpiarFiltros()">
          <i class="bi bi-arrow-counterclockwise"></i> Resetear filtros
        </button>
      </div>
    </ng-template>
  </div>
</div>

<!-- 游댠 MODAL EDITAR -->
<div class="custom-backdrop" *ngIf="mostrarModalActualizar">
  <div class="custom-modal-box">
    <div class="modal-header bg-success text-white d-flex justify-content-between align-items-center">
      <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Editar Reserva</h5>
      <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()" [disabled]="procesando"></button>
    </div>
    <div class="modal-body mt-3">
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Editando reserva de <strong>{{ reservaSeleccionada?.tipo }}</strong>
      </div>

      <!-- Mostrar campo Espacio solo si es tipo Aula -->
      <div class="mb-3" *ngIf="reservaSeleccionada?.tipo === 'Aula'">
        <label class="form-label"><i class="bi bi-door-open"></i> Aula:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.espacio">
          <option *ngFor="let espacio of espacios" [value]="espacio.nombre">
            {{ espacio.nombre }}
          </option>
        </select>
      </div>

      <!-- Mostrar campo Recurso solo si es tipo Material -->
      <div class="mb-3" *ngIf="reservaSeleccionada?.tipo === 'Material'">
        <label class="form-label"><i class="bi bi-box"></i> Material:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.recurso">
          <option *ngFor="let material of materiales" [value]="material.nombre">
            {{ material.nombre }}
          </option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label"><i class="bi bi-calendar3"></i> Fecha:</label>
        <input type="date" class="form-control" [(ngModel)]="reservaSeleccionada.fecha" />
      </div>

      <!-- Select de Tramo Horario -->
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-clock"></i> Tramo Horario:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.tramoHorario">
          <option value="">Selecciona un tramo horario</option>
          <option *ngFor="let tramo of tramosHorarios" [value]="tramo">
            {{ tramo }}
          </option>
        </select>
      </div>
    </div>
    <div class="modal-footer d-flex justify-content-end">
      <button class="btn btn-secondary me-2" (click)="cerrarModal()" [disabled]="procesando">
        <i class="bi bi-x-circle"></i> Cancelar
      </button>
      <button class="btn btn-success" (click)="guardarCambios()" [disabled]="procesando">
        <span *ngIf="procesando" class="spinner-border spinner-border-sm me-2"></span>
        <i *ngIf="!procesando" class="bi bi-check-circle"></i> Guardar Cambios
      </button>
    </div>
  </div>
</div>

<!-- 游댠 MODAL ELIMINAR/CANCELAR -->
<div class="custom-backdrop" *ngIf="mostrarModalEliminar">
  <div class="custom-modal-box text-center">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title w-100"><i class="bi bi-exclamation-triangle"></i> Confirmar Cancelaci칩n</h5>
    </div>
    <div class="modal-body">
      <p class="fs-5">쮼st치s seguro de que deseas cancelar esta reserva?</p>
      <p class="text-muted">Esta acci칩n no se puede deshacer.</p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn btn-danger me-3" (click)="confirmarEliminacion()" [disabled]="procesando">
        <span *ngIf="procesando" class="spinner-border spinner-border-sm me-2"></span>
        <i *ngIf="!procesando" class="bi bi-check-circle-fill"></i> S칤, cancelar
      </button>
      <button class="btn btn-secondary" (click)="cancelarEliminacion()" [disabled]="procesando">
        <i class="bi bi-x-circle-fill"></i> No, volver
      </button>
    </div>
  </div>
</div>

<!-- 游댠 MODAL DE CONFLICTO (Espacio/Recurso ocupado) -->
<div class="custom-backdrop" *ngIf="mostrarModalConflicto">
  <div class="custom-modal-box">
    <div class="modal-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Espacio No Disponible</h5>
      <button type="button" class="btn-close" (click)="cerrarModalConflicto()"></button>
    </div>
    <div class="modal-body">
      <div class="alert alert-warning mb-3">
        <h6 class="alert-heading">丘멆잺 Esta reserva ya est치 ocupada</h6>
        <hr>
        <p class="mb-2">
          <strong>{{ conflictoInfo?.nombreEspacio || conflictoInfo?.nombreRecurso }}</strong>
          ya est치 reservado para:
        </p>
        <ul class="mb-0">
          <li><strong>Fecha:</strong> {{ conflictoInfo?.fecha }}</li>
          <li><strong>Horario:</strong> {{ conflictoInfo?.tramo }}</li>
          <li><strong>Reservado por:</strong> {{ conflictoInfo?.reservadoPor }}</li>
        </ul>
      </div>

      <p class="text-muted">
        <i class="bi bi-info-circle"></i>
        Como profesor, no puedes cancelar reservas de otros profesores.
        Puedes mantener tu reserva actual o elegir otra fecha/horario.
      </p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn btn-primary" (click)="mantenerReservaActual()">
        <i class="bi bi-arrow-left-circle"></i> Mantener mi reserva actual
      </button>
    </div>
  </div>
</div>

<!-- 游댠 MODAL INFORMATIVO (Success/Error/Warning/Info) -->
<div class="custom-backdrop" *ngIf="mostrarModalInformativo">
  <div class="custom-modal-box text-center">
    <div class="modal-header" [ngClass]="{
           'bg-success text-white': tipoMensaje === 'success',
           'bg-danger text-white': tipoMensaje === 'error',
           'bg-warning text-dark': tipoMensaje === 'warning',
           'bg-info text-white': tipoMensaje === 'info'
         }">
      <h5 class="modal-title w-100">
        <i class="bi" [ngClass]="{
             'bi-check-circle-fill': tipoMensaje === 'success',
             'bi-x-circle-fill': tipoMensaje === 'error',
             'bi-exclamation-triangle-fill': tipoMensaje === 'warning',
             'bi-info-circle-fill': tipoMensaje === 'info'
           }"></i>
        {{ tipoMensaje === 'success' ? '칄xito' :
        tipoMensaje === 'error' ? 'Error' :
        tipoMensaje === 'warning' ? 'Advertencia' : 'Informaci칩n' }}
      </h5>
    </div>
    <div class="modal-body">
      <p class="fs-5 mb-0">{{ mensajeInformativo }}</p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn" [ngClass]="{
                'btn-success': tipoMensaje === 'success',
                'btn-danger': tipoMensaje === 'error',
                'btn-warning': tipoMensaje === 'warning',
                'btn-info': tipoMensaje === 'info'
              }" (click)="cerrarModalInformativo()">
        <i class="bi bi-check-lg"></i> Cerrar
      </button>
    </div>
  </div>
</div>