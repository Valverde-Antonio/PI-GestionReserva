<div class="container mt-4">
  <h2 class="mb-3">Todas las Reservas</h2>

  <div class="row g-3 mb-4">
    <!-- Fecha Desde -->
    <div class="col-md-3">
      <label class="form-label"><i class="bi bi-calendar3"></i> Fecha Desde:</label>
      <input type="date" class="form-control" [(ngModel)]="filtroFechaDesde" (change)="filtrarReservas()">
    </div>

    <!-- Fecha Hasta -->
    <div class="col-md-3">
      <label class="form-label"><i class="bi bi-calendar3"></i> Fecha Hasta:</label>
      <input type="date" class="form-control" [(ngModel)]="filtroFechaHasta" (change)="filtrarReservas()">
    </div>
    <div class="col-md-3">
      <label class="form-label">Filtrar por tipo:</label>
      <select class="form-select" [(ngModel)]="filtroTipo" (change)="filtrarReservas()">
        <option value="Todas">Todas</option>
        <option value="Material">Material</option>
        <option value="Aula">Aula</option>
      </select>
    </div>

    <div class="col-md-3" *ngIf="filtroTipo === 'Aula'">
      <label class="form-label">Filtrar por aula:</label>
      <select class="form-select" [(ngModel)]="filtroAula" (change)="filtrarReservas()">
        <option value="">Todas</option>
        <option *ngFor="let espacio of espacios" [value]="espacio.nombre">{{ espacio.nombre }}</option>
      </select>
    </div>

    <div class="col-md-3" *ngIf="filtroTipo === 'Material'">
      <label class="form-label">Filtrar por material:</label>
      <select class="form-select" [(ngModel)]="filtroMaterial" (change)="filtrarReservas()">
        <option value="">Todos</option>
        <option *ngFor="let material of materiales" [value]="material.nombre">{{ material.nombre }}</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Filtrar por profesor:</label>
      <select class="form-select" [(ngModel)]="filtroProfesor" (change)="filtrarReservas()">
        <option value="">Todos</option>
        <option *ngFor="let prof of profesores" [value]="prof.nombre">{{ prof.nombre }}</option>
      </select>
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-secondary w-100" (click)="limpiarFiltros()">Limpiar Filtros</button>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-success w-100" (click)="exportarPDFTodasReservas()"
        [disabled]="filtradoReservas.length === 0">
        <i class="bi bi-file-earmark-pdf"></i> Exportar a PDF
      </button>
    </div>
  </div>

  <div *ngIf="reservasPaginadas.length > 0; else noResultados">
    <div class="card mb-3" *ngFor="let r of reservasPaginadas">
      <div class="card-body">
        <h5 class="card-title">{{ r.tipo === 'Aula' ? r.espacio : r.recurso }}</h5>
        <p class="card-text">
          <strong>Fecha:</strong> {{ r.fecha }}<br>
          <strong>Hora:</strong> {{ r.horaInicio }}<br>
          <strong>Profesor:</strong> {{ r.profesor }}<br>
          <strong>Estado:</strong>
          <span [ngClass]="{'text-success': r.estado === 'Finalizada', 'text-danger': r.estado === 'Cancelada'}">
            {{ r.estado }}
          </span>
        </p>
        <div class="d-flex justify-content-end gap-2">
          <button class="btn btn-outline-primary btn-sm" (click)="modificarReserva(r)" [disabled]="procesando">
            <i class="bi bi-pencil"></i> Editar
          </button>
          <button class="btn btn-outline-danger btn-sm" (click)="eliminarReserva(r)" [disabled]="procesando">
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </div>
      </div>
    </div>

    <nav class="d-flex justify-content-center mt-4">
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="cambiarPagina(currentPage - 1)">Anterior</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">Página {{ currentPage }} / {{ totalPages }}</span>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="cambiarPagina(currentPage + 1)">Siguiente</a>
        </li>
      </ul>
    </nav>
  </div>

  <ng-template #noResultados>
    <div class="alert alert-warning text-center mt-4">
      No hay reservas que coincidan con los filtros aplicados.
    </div>
  </ng-template>
</div>

<!-- Modal Editar -->
<div class="custom-backdrop" *ngIf="mostrarModalActualizar">
  <div class="custom-modal-box">
    <div class="modal-header bg-success text-white d-flex justify-content-between align-items-center">
      <h5 class="modal-title">Editar Reserva</h5>
      <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()" [disabled]="procesando"></button>
    </div>
    <div class="modal-body mt-3">
      <div class="mb-3">
        <label class="form-label">Profesor:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.profesor">
          <option *ngFor="let prof of profesores" [value]="prof.nombre">{{ prof.nombre }}</option>
        </select>
      </div>

      <!-- Mostrar campo Espacio solo si es tipo Aula -->
      <div class="mb-3" *ngIf="reservaSeleccionada?.tipo === 'Aula'">
        <label class="form-label">Espacio:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.espacio">
          <option *ngFor="let espacio of espacios" [value]="espacio.nombre">
            {{ espacio.nombre }}
          </option>
        </select>
      </div>

      <!-- Mostrar campo Recurso solo si es tipo Material -->
      <div class="mb-3" *ngIf="reservaSeleccionada?.tipo === 'Material'">
        <label class="form-label">Recurso:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.recurso">
          <option *ngFor="let material of materiales" [value]="material.nombre">
            {{ material.nombre }}
          </option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Fecha:</label>
        <input type="date" class="form-control" [(ngModel)]="reservaSeleccionada.fecha" />
      </div>

      <!-- Select de Tramo Horario -->
      <div class="mb-3">
        <label class="form-label">Tramo Horario:</label>
        <select class="form-select" [(ngModel)]="reservaSeleccionada.horaInicio">
          <option value="">Selecciona un tramo horario</option>
          <option *ngFor="let tramo of tramosHorarios" [value]="tramo">
            {{ tramo }}
          </option>
        </select>
      </div>
    </div>
    <div class="modal-footer d-flex justify-content-end">
      <button class="btn btn-secondary me-2" (click)="cerrarModal()" [disabled]="procesando">Cancelar</button>
      <button class="btn btn-success" (click)="guardarCambios()" [disabled]="procesando">
        <span *ngIf="procesando" class="spinner-border spinner-border-sm me-2"></span>
        Guardar Cambios
      </button>
    </div>
  </div>
</div>

<!-- Modal Eliminar -->
<div class="custom-backdrop" *ngIf="mostrarModalEliminar">
  <div class="custom-modal-box text-center">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title w-100">Confirmar Eliminación</h5>
    </div>
    <div class="modal-body">
      <p class="fs-5">¿Estás seguro de que deseas eliminar esta reserva?</p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn btn-outline-danger me-3" (click)="confirmarEliminacion()" [disabled]="procesando">
        <span *ngIf="procesando" class="spinner-border spinner-border-sm me-2"></span>
        <i class="bi bi-check-circle-fill"></i> Sí
      </button>
      <button class="btn btn-outline-secondary" (click)="cancelarEliminacion()" [disabled]="procesando">
        <i class="bi bi-x-circle-fill"></i> No
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE CONFLICTO (PRIVILEGIOS DE DIRECTIVO) -->
<div class="custom-backdrop" *ngIf="mostrarModalConflicto">
  <div class="custom-modal-box">
    <div class="modal-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h5 class="modal-title">
        <i class="bi bi-exclamation-triangle-fill"></i> Espacio No Disponible - Privilegios de Directivo
      </h5>
      <button type="button" class="btn-close" (click)="cerrarModalConflicto()" [disabled]="procesando"></button>
    </div>
    <div class="modal-body">
      <div class="alert alert-warning mb-3">
        <h6 class="alert-heading">⚠️ Esta reserva ya está ocupada</h6>
        <hr>
        <p class="mb-2">
          <strong>{{ conflictoInfo?.nombreEspacio || conflictoInfo?.nombreRecurso }}</strong>
          ya está reservado para:
        </p>
        <ul class="mb-0">
          <li><strong>Fecha:</strong> {{ conflictoInfo?.fecha }}</li>
          <li><strong>Horario:</strong> {{ conflictoInfo?.tramo }}</li>
          <li><strong>Reservado por:</strong> {{ conflictoInfo?.reservadoPor }}</li>
        </ul>
      </div>

      <div class="alert alert-info mb-0">
        <h6 class="alert-heading">
          <i class="bi bi-shield-check"></i> Privilegios de Directivo
        </h6>
        <p class="mb-0">
          Como directivo, tienes la opción de <strong>eliminar la reserva que está ocupando este
            espacio/horario</strong>
          para poder proceder con tu modificación.
        </p>
      </div>
    </div>
    <div class="modal-footer d-flex justify-content-between">
      <button class="btn btn-secondary" (click)="mantenerReservaActual()" [disabled]="procesando">
        <i class="bi bi-arrow-left-circle"></i> Mantener reserva original
      </button>
      <button class="btn btn-danger" (click)="eliminarReservaConflictivaYModificar()" [disabled]="procesando">
        <span *ngIf="procesando" class="spinner-border spinner-border-sm me-2"></span>
        <i *ngIf="!procesando" class="bi bi-trash-fill"></i> Eliminar reserva conflictiva y modificar
      </button>
    </div>
  </div>
</div>

<!--MODAL INFORMATIVO-->
<div class="custom-backdrop" *ngIf="mostrarModalInformativo">
  <div class="custom-modal-box text-center">
    <div class="modal-header" [ngClass]="{
           'bg-success text-white': tipoMensaje === 'success',
           'bg-danger text-white': tipoMensaje === 'error',
           'bg-warning text-dark': tipoMensaje === 'warning',
           'bg-info text-white': tipoMensaje === 'info'
         }">
      <h5 class="modal-title w-100">
        <i class="bi" [ngClass]="{
             'bi-check-circle-fill': tipoMensaje === 'success',
             'bi-x-circle-fill': tipoMensaje === 'error',
             'bi-exclamation-triangle-fill': tipoMensaje === 'warning',
             'bi-info-circle-fill': tipoMensaje === 'info'
           }"></i>
        {{ tipoMensaje === 'success' ? 'Éxito' :
        tipoMensaje === 'error' ? 'Error' :
        tipoMensaje === 'warning' ? 'Advertencia' : 'Información' }}
      </h5>
    </div>
    <div class="modal-body">
      <p class="fs-5 mb-0">{{ mensajeInformativo }}</p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn" [ngClass]="{
                'btn-success': tipoMensaje === 'success',
                'btn-danger': tipoMensaje === 'error',
                'btn-warning': tipoMensaje === 'warning',
                'btn-info': tipoMensaje === 'info'
              }" (click)="cerrarModalInformativo()">
        <i class="bi bi-check-lg"></i> Cerrar
      </button>
    </div>
  </div>
</div>